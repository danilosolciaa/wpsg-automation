

<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="utf-8" />
    <title id="dbTitle">Standards Under Development - Database</title>
    <script type="text/javascript" src="/eel.js"></script>
    <style>
        @import url("https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css");
        @import url("https://fonts.googleapis.com/css?family=Montserrat:700,600,400|Source+Sans+Pro:700,400");
        
        .stats-row .stat-item:has(#lastUpdate) { display: none; }
        
        * {
            -webkit-font-smoothing: antialiased;
            box-sizing: border-box;
        }
        
        :root{
            --brand-blue: #1F4E8C;
            --brand-blue-dark: #173B6B;
            --brand-blue-weak: #E7F0FF;
        }
        
        html, body { 
            margin: 0; 
            padding: 0; 
            width: 100vw;
            height: 100vh;
            min-width: 900px; 
            min-height: 590px;
            max-width: 100vw;
            max-height: 100vh; 
            overflow: hidden;
            font-family: 'Source Sans Pro', sans-serif; 
            background-color: #ffffff;
            box-sizing: border-box;
        }

        /* Expandable window feature */
        .box {
            width: 100%;
            height: 100%;
            min-width: 900px;
            min-height: 590px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            position: relative;
            box-sizing: border-box;
        }

        /* CHANGED: Expand message - now a non-floating text element */
        .expand-message {
            position: absolute;        /* CHANGED: was fixed */
            left: 0;
            right: 0;
            bottom: 8px;               /* sits at the bottom edge inside the app */
            font-family: "Source Sans Pro", Helvetica;
            font-size: 14px;
            font-weight: 700;
            color: #1F4E8C;
            text-align: center;
            pointer-events: none;      /* optional: never blocks clicks */
        }

        .expand-message .arrow {
            font-size: 16px;
            margin-right: 5px;
        }

        /* Language Toggle */
        .language-toggle {
            position: absolute;
            top: 16.5px;
            left: 95px;
            z-index: 1000;
        }

        .lang-btn {
            background: none;
            border: 1px solid #ddd;
            font-size: 10px;
            padding: 2px 6px;
            margin-right: 2px;
            cursor: pointer;
            border-radius: 2px;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: #1F4E8C;
            color: white;
            border-color: #1F4E8C;
        }

        .lang-btn:hover {
            background: #f0f0f0;
        }

        .lang-btn.active:hover {
            background: #173B6B;
        }


        .language-toggle .lang-btn.active {
            background: #1F4E8C !important;
            color: white !important;
            border-color: #1F4E8C !important;
        }

        /* Header */
        .header {
            position: absolute;
            top: 16px;
            left: 20px;
            z-index: 100;
        }
        
        .back-button {
            background: none;
            border: none;
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 700;
            color: var(--brand-blue);
            font-size: 14px;
            cursor: pointer;
            text-decoration: underline;
            margin-bottom: 8px;
        }
        
        .back-button:hover {
            opacity: 0.7;
        }
        
        .page-title {
            font-family: "Montserrat", Helvetica;
            font-weight: 700;
            color: #000000;
            font-size: 24px;
            letter-spacing: -0.5px;
            margin-bottom: 4px;
        }
        
        .page-subtitle {
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 400;
            color: #666;
            font-size: 12px;
            margin-bottom: 6px;  
        }

        .main-content {


            flex: 1;
            margin-top: 108px;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 48px; 

            display: flex;
            flex-direction: column;

            min-height: 0;
        }

        
        /* Logo */
        .nvc-logo {
            position: absolute;
            width: 150px;
            height: auto;
            top: 16px;
            right: 14px;
            object-fit: contain;
        }

        /* Edit Database Button */
        .edit-db-button {
            position: absolute;
            top: 60px;
            right: 14px;
            background: linear-gradient(135deg, #1F4E8C, #2563eb);
            border: none;
            border-radius: 6px;
            color: white;
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 600;
            font-size: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edit-db-button:hover {
            background: linear-gradient(135deg, #173B6B, #1d4ed8);
            transform: translateY(-1px);
        }
        
        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 2px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-label {
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 700;
            color: #000000;
            font-size: 13px;
        }
        
        .filter-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: "Source Sans Pro", Helvetica;
            font-size: 12px;
            background: white;
        }
        
        .filter-input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: "Source Sans Pro", Helvetica;
            font-size: 12px;
            width: 200px;
        }
        
        /* Statistics Row */
        .stats-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid var(--brand-blue);
        }
        
        .stat-value {
            font-family: "Montserrat", Helvetica;
            font-weight: 700;
            color: #000000;
            font-size: 18px;
        }
        
        .stat-label {
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 400;
            color: #666;
            font-size: 11px;
            margin-top: 2px;
        }
        
        /* Table Container */
       .table-container {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            min-height: 0; /* ensures flex child can shrink within column */
        }
        
       .table-wrapper {
        overflow-y: auto;
        overflow-x: auto; /* none is invalid */
        padding-bottom: 16px;
        scroll-padding-bottom: 16px;
        }
        
        /* Table Styles */
        .standards-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .standards-table th {
            background: #f8f9fa;
            padding: 8px;
            text-align: left;
            border-bottom: 2px solid #ddd;
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 700;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .standards-table td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 400;
            vertical-align: top;
        }
        
        .standards-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-size: 14px;
        }
        
        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-size: 14px;
        }
        
        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-family: "Source Sans Pro", Helvetica;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: #f8f9fa;
        }
        
        .action-btn.primary {
            background-color: var(--brand-blue);
            color: white;
            border-color: var(--brand-blue);
        }
        
        .action-btn.primary:hover {
            background-color: var(--brand-blue-dark);
        }

        .table-container {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow: hidden;
            background: white;
            min-height: 0; /* ADDED: Ensures flex item can shrink */
        }

        .table-wrapper {
            height: 100%;
            max-height: 100%; /* ADDED: Ensures scrolling kicks in */
            overflow-y: auto;
            overflow-x: none; /* ADDED: Handle wide tables */
        }
        
        /* Custom Scrollbar */
        .table-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Database Edit Modal */
        .db-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .db-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 950px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            font-family: "Source Sans Pro", Helvetica;
        }

        .db-modal h3 {
            margin: 0 0 15px 0;
            color: #1F4E8C;
            font-size: 18px;
            font-weight: 700;
        }

        .db-form-group {
            margin-bottom: 15px;
        }

        .db-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .db-form-group input,
        .db-form-group select,
        .db-form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .db-form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .db-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .db-modal button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .db-modal .btn-primary {
            background-color: #1F4E8C;
            color: white;
        }

        .db-modal .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .db-modal .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .db-footer {
            position: absolute;
            bottom: 8px;
            right: 14px;
            font-family: "Source Sans Pro", Helvetica;
            font-weight: 400;
            color: #666;
            font-size: 11px;
            text-align: right;
            letter-spacing: 0;
            line-height: normal;
        }
    </style>
</head>
<body>
    <div class="box" id="mainBox">
        <!-- Language Toggle -->
        <div class="language-toggle" hidden>
            <button class="lang-btn" id="nlBtn">NL</button>
            <button class="lang-btn" id="enBtn">EN</button>
        </div>

        <!-- Header -->
        <div class="header">
            <button class="back-button" onclick="goBack()" id="backButton">‚Üê Back</button>
            <div class="page-title" id="pageTitle">Standards Under Development - Database</div>
            <div class="page-subtitle" id="dbSubtitle">Loading database information...</div>
        </div>
        
        <!-- Logo -->
        <img src="./img/NVC-Packaging-Centre-1-scaled-1616664239.png" alt="NVC Packaging Centre" class="nvc-logo" />
        
        <!-- Edit Database Button -->
        <button class="edit-db-button" id="editDbButton" hidden>
            <span id="editDbText">üìù Edit Database</span>
        </button>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-group">
                    <span class="filter-label" id="orgLabel">Organization:</span>
                    <select class="filter-select" id="orgFilter">
                        <option value="all" id="orgAll">All</option>
                        <option value="cen">CEN</option>
                        <option value="iso">ISO</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label" id="searchLabel">Search:</span>
                    <input type="text" class="filter-input" id="searchInput" placeholder="E.g. EN 18120-1, committee, title...">
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="action-btn primary" onclick="refreshData()" id="refreshBtn">Refresh Data</button>
                <button class="action-btn" onclick="exportData()" id="exportBtn">Export CSV</button>
                <button class="action-btn" onclick="importData()" id="importBtn">Import Data</button>
            </div>
            
            <!-- Statistics -->
            <div class="stats-row" id="statsRow">
                <div class="stat-item">
                    <div class="stat-value" id="totalCount">-</div>
                    <div class="stat-label" id="totalLabel">Total Standards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="cenCount">-</div>
                    <div class="stat-label" id="cenLabel">CEN Standards</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="isoCount">-</div>
                    <div class="stat-label" id="isoLabel">ISO Standards</div>
                </div>
            </div>
            
            <!-- Table Container -->
            <div class="table-container">
                <div class="table-wrapper" id="tableWrapper">
                    <div class="loading" id="loadingState">Loading standards data...</div>
                </div>
            </div>
        </div>

        <!-- CHANGED: Non-floating expand message -->
        <div class="expand-message" id="expandMessage" hidden>
            <span class="arrow">‚Üï</span><span id="expandText">Window expandable - scroll up/down</span>
        </div>

    </div>

    <!-- Database Edit Modal -->
    <div id="dbModal" class="db-modal">
        <div class="db-modal-content">
            <h3 id="dbModalTitle">Edit Database Record</h3>
            <form id="dbEditForm">
                <div class="db-form-group">
                    <label for="editReference" id="refLabel">Reference:</label>
                    <input type="text" id="editReference" placeholder="E.g. EN 18120-1">
                </div>
                
                <div class="db-form-group">
                    <label for="editTitle" id="titleLabel">Title:</label>
                    <textarea id="editTitle" placeholder="Standard title"></textarea>
                </div>
                
                <div class="db-form-group">
                    <label for="editCommittee" id="committeeLabel">Committee:</label>
                    <input type="text" id="editCommittee" placeholder="E.g. CEN/TC 261">
                </div>
                
                <div class="db-form-group">
                    <label for="editWiNumber" id="wiLabel">WI Number:</label>
                    <input type="text" id="editWiNumber" placeholder="WI=00261514">
                </div>
                
                <div class="db-form-group">
                    <label for="editOrganization" id="organizationLabel">Organization:</label>
                    <select id="editOrganization">
                        <option value="CEN">CEN</option>
                        <option value="ISO">ISO</option>
                    </select>
                </div>
                
                <div class="db-form-group">
                    <label for="editCategory" id="categoryLabel">Category:</label>
                    <input type="text" id="editCategory" placeholder="E.g. packaging">
                </div>
            </form>
            
            <div class="db-modal-buttons">
                <button type="button" class="btn-danger" id="dbDeleteBtn">Delete</button>
                <button type="button" class="btn-secondary" id="dbCancelBtn">Cancel</button>
                <button type="button" class="btn-primary" id="dbSaveBtn">Save</button>
            </div>
        </div>
    </div>
    
    <script>
        let currentData = null;
        let filteredData = [];
        let currentDbType = 'under_development';
        let currentLanguage = 'en'; // CHANGED: Default to English
        let editingRecord = null;

        // Translations object
        const translations = {
            nl: {
                pageTitle: "Normen in Ontwikkeling - Database",
                recentTitle: "Recent Gepubliceerd - Database", 
                deletedTitle: "ISO Verwijderd - Database",
                loading: "Laden...",
                loadingStandards: "Normen gegevens laden...",
                loadingDb: "Database informatie laden...",
                back: "‚Üê Terug",
                organization: "Organisatie:",
                search: "Zoeken:",
                all: "Alle",
                refreshData: "Gegevens Verversen",
                exportCsv: "Exporteer CSV",
                importData: "Importeer Gegevens",
                totalStandards: "Totaal Normen",
                cenStandards: "CEN Normen", 
                isoStandards: "ISO Normen",
                reference: "Referentie",
                title: "Titel",
                committee: "Commissie",
                wiNumber: "WI Nummer",
                category: "Categorie",
                organization_col: "Organisatie",
                noDataFound: "Geen gegevens gevonden die overeenkomen met uw criteria",
                tryAdjusting: "Probeer uw filters of zoektermen aan te passen",
                editDatabase: "üìù Database Bewerken",
                expandWindow: "Venster uitbreidbaar - scroll omhoog/omlaag",
                editRecord: "Database Record Bewerken",
                delete: "Verwijderen",
                cancel: "Annuleren", 
                save: "Opslaan"
            },
            en: {
                pageTitle: "Standards Under Development - Database",
                recentTitle: "Recently Published - Database",
                deletedTitle: "ISO Deleted - Database", 
                loading: "Loading...",
                loadingStandards: "Loading standards data...",
                loadingDb: "Loading database information...",
                back: "‚Üê Back",
                organization: "Organization:",
                search: "Search:",
                all: "All",
                refreshData: "Refresh Data",
                exportCsv: "Export CSV", 
                importData: "Import Data",
                totalStandards: "Total Standards",
                cenStandards: "CEN Standards",
                isoStandards: "ISO Standards",
                reference: "Reference",
                title: "Title",
                committee: "Committee", 
                wiNumber: "WI Number",
                category: "Category",
                organization_col: "Organization",
                noDataFound: "No data found matching your criteria",
                tryAdjusting: "Try adjusting your filters or search terms",
                editDatabase: "üìù Edit Database",
                expandWindow: "Window expandable - scroll up/down",
                editRecord: "Edit Database Record",
                delete: "Delete",
                cancel: "Cancel",
                save: "Save"
            }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get database type from URL params
            const urlParams = new URLSearchParams(window.location.search);
            currentDbType = urlParams.get('type') || 'under_development';
            
            // CHANGED: Get language from URL params for congruency
            const urlLanguage = urlParams.get('lang');
            if (urlLanguage) {
                currentLanguage = urlLanguage;
            } else {
                // CHANGED: Check localStorage for language congruency
                const savedLanguage = localStorage.getItem('wpsg_language');
                if (savedLanguage) {
                    currentLanguage = savedLanguage;
                }
            }
            
            
            loadLanguage();
            loadData();
            setupEventListeners();
        });

        function loadLanguage() {
            updateLanguageUI();
            // Ensure the toggle reflects the language on first paint
            setLangButtons(); 
        }

        function updateLanguageUI() {
            const t = translations[currentLanguage];
            
            // Update title based on database type
            let titleKey = 'pageTitle';
            if (currentDbType === 'recently_published') titleKey = 'recentTitle';
            if (currentDbType === 'iso_deleted') titleKey = 'deletedTitle';
            
            document.getElementById('pageTitle').textContent = t[titleKey];
            document.getElementById('backButton').textContent = t.back;
            document.getElementById('orgLabel').textContent = t.organization;
            document.getElementById('searchLabel').textContent = t.search;
            document.getElementById('orgAll').textContent = t.all;
            document.getElementById('refreshBtn').textContent = t.refreshData;
            document.getElementById('exportBtn').textContent = t.exportCsv;
            document.getElementById('importBtn').textContent = t.importData;
            document.getElementById('totalLabel').textContent = t.totalStandards;
            document.getElementById('cenLabel').textContent = t.cenStandards;
            document.getElementById('isoLabel').textContent = t.isoStandards;
            document.getElementById('loadingState').textContent = t.loadingStandards;
            document.getElementById('editDbText').textContent = t.editDatabase;
            document.getElementById('expandText').textContent = t.expandWindow;
            
            // FIXED: Update language toggles properly
            document.getElementById('nlBtn').classList.toggle('active', currentLanguage === 'nl');
            document.getElementById('enBtn').classList.toggle('active', currentLanguage === 'en');
        }

        function setupEventListeners() {
            document.getElementById('orgFilter').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('editDbButton').addEventListener('click', openEditModal);
            
            document.getElementById('nlBtn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); switchLanguage('nl'); });
            document.getElementById('enBtn').addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); switchLanguage('en'); });

            // Modal handlers
            document.getElementById('dbCancelBtn').addEventListener('click', closeEditModal);
            document.getElementById('dbSaveBtn').addEventListener('click', saveRecord);
            document.getElementById('dbDeleteBtn').addEventListener('click', deleteRecord);
            
            // Close modal when clicking outside
            document.getElementById('dbModal').addEventListener('click', (e) => {
                if (e.target.id === 'dbModal') closeEditModal();
            });
        }

        async function switchLanguage(lang) {
            if (lang !== 'nl' && lang !== 'en') return;
            
            try {
                currentLanguage = lang;
                localStorage.setItem('wpsg_language', lang);
                
                // FIXED: Update backend like main page does
                const success = await eel.set_language(lang)();
                
                if (success) {
                    updateLanguageUI();      // update texts
                    setLangButtons();        // force visual toggle
                    if (currentData && currentData.metadata) updateSubtitle();
                    console.log('Language switched to:', lang);
                } else {
                    console.error('Failed to update language in backend');
                }
            } catch (error) {
                console.error('Error switching language:', error);
            }
        }



        function setLangButtons() {
            const nlBtn = document.getElementById('nlBtn');
            const enBtn = document.getElementById('enBtn');

            // Reset
            nlBtn.classList.remove('active');
            enBtn.classList.remove('active');

            // Apply active class based on current language
            if (currentLanguage === 'nl') {
                nlBtn.classList.add('active');
            } else {
                enBtn.classList.add('active');
            }
            
            // Force a reflow to ensure the styles are applied
            void nlBtn.offsetWidth;
            void enBtn.offsetWidth;
        }

        async function loadData() {
            try {
                currentData = await eel.get_standards_data(null, currentDbType)();
                updateSubtitle();
                setLangButtons();
                updateStatistics();
                applyFilters();
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load standards data');
            }
        }

        function updateSubtitle() {
            if (currentData && currentData.metadata) {
                const lastUpdated = new Date(currentData.metadata.last_updated).toLocaleDateString();
                const t = translations[currentLanguage];
                document.getElementById('dbSubtitle').textContent = 
                    `Last updated: ${lastUpdated} ‚Ä¢ Version: ${currentData.metadata.version}`;
            }
        }

        function updateStatistics() {
            if (!currentData) return;
            
            let totalCount = 0;
            let cenCount = 0;
            let isoCount = 0;
            
            if (currentData.cen_standards && Array.isArray(currentData.cen_standards)) {
                cenCount = currentData.cen_standards.length;
            }
            
            if (currentData.iso_standards && Array.isArray(currentData.iso_standards)) {
                isoCount = currentData.iso_standards.length;
            }
            
            totalCount = cenCount + isoCount;
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('cenCount').textContent = cenCount;
            document.getElementById('isoCount').textContent = isoCount;
        }

        function applyFilters() {
            if (!currentData) return;
            
            const orgFilter = document.getElementById('orgFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = [];
            
            // Process CEN standards
            if (orgFilter === 'all' || orgFilter === 'cen') {
                processStandards(currentData.cen_standards, 'CEN', searchTerm);
            }
            
            // Process ISO standards
            if (orgFilter === 'all' || orgFilter === 'iso') {
                processStandards(currentData.iso_standards, 'ISO', searchTerm);
            }
            
            renderTable();
        }

        function processStandards(standards, orgType, searchTerm) {
            if (!standards || !Array.isArray(standards)) return;
            
            standards.forEach(standard => {
                // Enhanced search - check multiple fields
                if (searchTerm) {
                    const searchFields = [
                        standard.reference,
                        standard.title,
                        standard.committee,
                        standard.wi_number,
                        standard.category
                    ].filter(field => field).join(' ').toLowerCase();
                    
                    if (!searchFields.includes(searchTerm)) {
                        return;
                    }
                }
                
                filteredData.push({
                    ...standard,
                    organization: orgType
                });
            });
        }

        function renderTable() {
            const tableWrapper = document.getElementById('tableWrapper');
            const t = translations[currentLanguage];
            
            if (filteredData.length === 0) {
                tableWrapper.innerHTML = `
                    <div class="empty-state">
                        <div>${t.noDataFound}</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #999;">
                            ${t.tryAdjusting}
                        </div>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <table class="standards-table">
                    <thead>
                        <tr>
                            <th>${t.organization_col}</th>
                            <th>${t.reference}</th>
                            <th>${t.title}</th>
                            <th>${t.committee}</th>
                            <th>${t.wiNumber}</th>
                            <th>${t.category}</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredData.map((standard, index) => renderTableRow(standard, index)).join('')}
                    </tbody>
                </table>
            `;
            
            tableWrapper.innerHTML = tableHTML;
        }

        function renderTableRow(standard, index) {
            return `
                <tr onclick="editRecord(${index})">
                    <td>${standard.organization}</td>
                    <td><strong>${standard.reference || '-'}</strong></td>
                    <td>${standard.title || '-'}</td>
                    <td>${standard.committee || '-'}</td>
                    <td>${standard.wi_number || '-'}</td>
                    <td>${standard.category || '-'}</td>
                    <td>
                        <button onclick="editRecord(${index}); event.stopPropagation();" style="font-size: 11px; padding: 2px 6px;">‚úèÔ∏è</button>
                    </td>
                </tr>
            `;
        }

        function openEditModal() {
            document.getElementById('dbModal').style.display = 'block';
            
            // Clear form
            document.getElementById('editReference').value = '';
            document.getElementById('editTitle').value = '';
            document.getElementById('editCommittee').value = '';
            document.getElementById('editWiNumber').value = '';
            document.getElementById('editOrganization').value = 'CEN';
            document.getElementById('editCategory').value = '';
            
            editingRecord = null;
        }

        function editRecord(index) {
            if (index >= 0 && index < filteredData.length) {
                const record = filteredData[index];
                editingRecord = index;
                
                document.getElementById('editReference').value = record.reference || '';
                document.getElementById('editTitle').value = record.title || '';
                document.getElementById('editCommittee').value = record.committee || '';
                document.getElementById('editWiNumber').value = record.wi_number || '';
                document.getElementById('editOrganization').value = record.organization || 'CEN';
                document.getElementById('editCategory').value = record.category || '';
                
                document.getElementById('dbModal').style.display = 'block';
            }
        }

        function closeEditModal() {
            document.getElementById('dbModal').style.display = 'none';
            editingRecord = null;
        }

        function saveRecord() {
            // In real implementation, this would save to backend
            const t = translations[currentLanguage];
            alert(`${t.save} functionality will be implemented in the next version`);
            closeEditModal();
        }

        function deleteRecord() {
            if (editingRecord !== null) {
                const t = translations[currentLanguage];
                if (confirm(`Are you sure you want to delete this record?`)) {
                    // In real implementation, this would delete from backend
                    alert(`${t.delete} functionality will be implemented in the next version`);
                    closeEditModal();
                }
            }
        }

        function showError(message) {
            document.getElementById('tableWrapper').innerHTML = `
                <div class="empty-state" style="color: #dc3545;">
                    <div>${message}</div>
                </div>
            `;
        }

        // Action functions
        function goBack() {
            // Resize window before navigating back
            try {
                window.resizeTo(930, 650);
            } catch (e) {
                console.log('Cannot resize window:', e);
            }
            
            // Small delay to ensure resize completes before navigation
            setTimeout(() => {
                window.location.href = `index.html?resetSize=true&lang=${currentLanguage}`;
            }, 100);
        }

        async function refreshData() {
            document.getElementById('loadingState').style.display = 'flex';
            document.getElementById('tableWrapper').innerHTML = '<div class="loading">Refreshing data...</div>';
            try {
                await loadData();
            } catch (error) {
                showError('Failed to refresh data');
            }
        }

        function exportData() {
            if (!filteredData.length) {
                alert('No data to export');
                return;
            }
            
            const headers = ['Organization', 'Reference', 'Title', 'Committee', 'WI Number', 'Category'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(row => [
                    row.organization,
                    `"${row.reference || ''}"`,
                    `"${row.title || ''}"`,
                    row.committee || '',
                    row.wi_number || '',
                    row.category || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wpsg_${currentDbType}_${new Date().toISOString().split('T')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function importData() {
            alert('Import functionality will be implemented in the next version');
        }

        // Expose functions for EEL integration
        window.dbViewer = {
            refreshData,
            getCurrentData: () => currentData,
            getFilteredData: () => filteredData,
            switchLanguage,
            editRecord,
            saveRecord,
            deleteRecord
        };
    </script>
</body>
</html>
